name: Lint and Format

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: build-and-test
  # If this is enabled it will cancel current running and start latest
  cancel-in-progress: true

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3.5.2
      with: 
        ref: ${{ github.head_ref }}
      
    - name: Setup Python
      uses: actions/setup-python@v4.6.0
      with:
        # Version range or exact version of Python or PyPy to use, using SemVer's version range syntax. Reads from .python-version if unset.
        python-version: 3.11.x # optional
        # Used to specify a package manager for caching in the default directory. Supported values: pip, pipenv, poetry.
        cache: pip # optional
        # The target architecture (x86, x64) of the Python or PyPy interpreter.
        architecture: x64 # optional
        # Set this option if you want the action to check for the latest available version that satisfies the version spec.
        check-latest: true # optional
    - name: Install black
      run: |
        pip install black
    - name: Run black
      run: |
        black .
    - uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: Apply formatting
  lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3.5.2
      
    - name: Setup Python
      uses: actions/setup-python@v4.6.0
      with:
        # Version range or exact version of Python or PyPy to use, using SemVer's version range syntax. Reads from .python-version if unset.
        python-version: 3.11.x # optional
        # Used to specify a package manager for caching in the default directory. Supported values: pip, pipenv, poetry.
        cache: pip # optional
        # The target architecture (x86, x64) of the Python or PyPy interpreter.
        architecture: x64 # optional
        # Set this option if you want the action to check for the latest available version that satisfies the version spec.
        check-latest: true # optional
    - name: Install ruff
      run: |
        pip install ruff
    - name: Run ruff
      run: |
        ruff . --fix --exit-zero 
    - uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: Apply linting
      # --exit-zero so it doesn't yell
  bandit:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3.5.2
      
    - name: Setup Python
      uses: actions/setup-python@v4.6.0
      with:
        # Version range or exact version of Python or PyPy to use, using SemVer's version range syntax. Reads from .python-version if unset.
        python-version: 3.11.x # optional
        # Used to specify a package manager for caching in the default directory. Supported values: pip, pipenv, poetry.
        cache: pip # optional
        # The target architecture (x86, x64) of the Python or PyPy interpreter.
        architecture: x64 # optional
        # Set this option if you want the action to check for the latest available version that satisfies the version spec.
        check-latest: true # optional
    - name: Install bandit
      run: |
        pip install bandit
    - name: Run bandit
      run: |
        bandit . -r --exit-zero 
      # --exit-zero so it doesn't yell
